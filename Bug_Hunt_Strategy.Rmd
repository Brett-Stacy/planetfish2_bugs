---
title: "Hunt Strategy"
author: "Brett Stacy"
date: "23 May 2019"
output: pdf_document
---

```{r, echo=F}
library(casal)
```

## List of To-Do's

  * Build model that generates SSB discrepency
    * Remove all estimated parameters from CASAL except B0
    * Set rec_mu == 1e6
    * Lots of tags
    
  * Extract CASAL arrays
    * catch at age
    * catch at length
    * fish scanned / recaptured
    
  * Compare extracted arrays to catch
  
  * Determine where para$sampling$catchage_N and para$sampling$catchlen_N show up in CASAL output.



  
  
## Code questions - Brett
Cannot supress YCS estimation through planetfish.
When I change bounds on YCS prior, they are not reflected in output.log. They remain the same as the default. Why?

Cannot supress q estimation through planetfish. Why?

WOW: PERFORMS BETTER WITH FEWER TAGS! I tried with 25,000 tags, 2,500 tags, 10 tags, and 2 tags. As the tag number decreased, the casal performs better at estimating SSB. Noteably, the estimate is still not good enough. This seems very odd. Perhaps the influence of other information is increasingly more influential as tag number decreases. My understanding is, the only other source of information in the survey is catch-at-age data. Could this truely be what is helping the casal model estimate SSB? And why does increasing the tag frequency hurt instead of help?

Run with low tags and low catchA (10 instead of 1000) data collection:
Performs as accurately as above, but not as precise. This must mean the majority of information contributing to the performance of the casal model is a combination of perfect knowledge of LHPs and catch data?

Run with low tags and low catchA but with TOP Growth. 30 iterations.:
PERFOMS REALLY WELL. 

Run with low tags and low catchA but on single_region_TOP.R:
Performs really BAD. Why would it perform well in last run but not this one? The only difference is the LHPs other than growth. I tried turning off estimating selectivity and it is still bad. I need to figure out what is going on with TOA_bug_1.R; how can it perform well when tags and catchA are reduced to unreasonably low levels?
CONCLUSION: The only evidence I can find that potentially explains the difference in performance between the two scripts is this: In the estimation.csl files, the only recaptured fish are caught earler in the sampling for TOA_bug_1 than in TOP_baseline_Minimum_Sampling (only recaptures for latter script were in 2010, the assessment year). Perhaps the earlier recaptures leads to better SSB quantification.
CONCLUSION: After increasing the tag-years and #tags to 20 in TOP_baseline_Minimum_Sampling, the performance was finally good, and the tag-recaptures happened sooner. This could mean that recaptures early-on are very important?
  
  
  
  
  
Change Growth to TOP:
PERFORMS WELL. => perhaps this is because somewhere along the line, the growth parameters are being used to calculate lengths. If this is happening, the fact that L_inf = 1565 is less than the modeled maximum length could produce problems. Mathematically, converting length to age using the von Bertalanffy relationship requires any length input to be less than L_inf. Otherwise, the log of a negative number is attempted. 

Change Growth to TOA S. Mormede 2015:
PERFORMS BAD.
  
  

Why aren't para\$sampling\$catchlen_N being communicated to CASAL? 
I can't find fish being measured anywhere in casal output.
CONCLUSION: This is because in para\$ass\$sample_years, catchlen == 0 for all years.



In Burch, et. al, "Within CASAL, releases-at-length of tagged fish were converted to releases-at-age via a
length-at-age conversion matrix assuming a von Bertalanffy growth function and parameters
from Table 1. Estimated recaptures-at-length were obtained by applying the same length-at-age
conversion matrix to the estimated recaptures-at-age."
BUT, with the L_inf problem, how could this conversion matrix be calculated for fishL > L_inf? And how do I access this matrix?


Tried Growth L_inf = 2265
PERFORMED BAD.



Tried TOP growth with all other LHPs for TOA, and No catchA
PERFORMED BAD.



Should datass = datass instead of datass = para/$ass in run_complete_casal_assessment()?
NO I don't think so because all it uses from para is casal_path, inputprefix, mpd_dat, output_log, linux, intern. 
This means it can use para. THe only thing in the function that uses para$ass is specific_ratios which I don't use. see function for more. Note I'm using run_casal_pointest()


datass <- get_casal_data(Yr_current=om$years[y], datass=datass, om=om, sampling=sampling, obs=obs, tag=tag, mod=mod)
This part of the code exists right before the creation of CASAL input files. datass is used in the input files.
Does get_casal_data() work like it should?


create_casal_file_est(params=datass, casal_path=ctrl\$casal_path, skel_csl=ctrl\$est_skel_csl, csl=ctrl\$est_csl)
Does the input datass accuratly transfer stuff to the estimation file?
Compare datass to read.casal.est.file()



Try TOA_bug_1 without plus group.
CONCLUSION: no effect.


  
## population.csl Questions
Should \@size_based False be True in population.csl?
I think it should be False because this is a age-based model.
  
  
  
  
  
  
  
  
## estimation.csl Questions

Do datass input parameter and estimation.csl line up?

### TOA

```{r, echo=F}
datass.TOA = readRDS("C:/Users/STA384/Documents/GitHub/planetfish2_bugs/Comparisons/datass_TOA_6_6_19")
estimation = extract.csl.file("C:/Users/STA384/Documents/GitHub/planetfish2_bugs/Output/TOA_bug_1/casal_estimation.csl")
size.class = datass.TOA$class_mins[-length(datass.TOA$class_mins)]

## TAGS RECAPTURED
tags.2009.om = datass.TOA$Rec_data$Tags2009_R1_R1
tags.2009.am = estimation$`tag_recapture[Tags2009_R1_R1]`$recaptured_2010

plot(size.class, tags.2009.om)
points(size.class, tags.2009.am, col = "red", pch = 3)


## TAGS SCANNED
tags.2009.om = datass.TOA$scannedN$Tags2009_R1_R1
tags.2009.am = estimation$`tag_recapture[Tags2009_R1_R1]`$scanned_2010

plot(size.class, tags.2009.om)
points(size.class, tags.2009.am, col = "red", pch = 3)


## AGE FREQUENCY
age.om = datass.TOA$catch_age$LL[,"2010",1,1,1]
age.am = as.numeric(estimation$`catch_at[LL_catchA]`$`2010`)

plot(age.om, ylim = c(0, 150))
points(age.am*500, col = "red", pch = 3)
lines(500*ogive("dbnormal", 1:35, params = list(top=10, sigma_left=2, sigma_right=10)))


```

CONCLUSION: How on earth does the operating model and subsequently assessment model know the selectivity in length if I provided it in age?
If it knows it in age, it must have converted it to length somehow to get these proportion scanned and recaptured fish by length. 

How is it getting big lengths at all in the first place?





Why does datass.TOA\$survey_age_n exist when there is no survey age stuff in para\$om?



### TOP
```{r, echo=F}
datass.TOP = readRDS("C:/Users/STA384/Documents/GitHub/planetfish2_bugs/Comparisons/datass_TOP_6_6_19")
estimation = extract.csl.file("C:/Users/STA384/Documents/GitHub/planetfish2_bugs/Comparisons/casal_estimation_TOP.csl")
size.class = datass.TOP$class_mins[-length(datass.TOP$class_mins)]

## TAGS RECAPTURED
tags.2009.om = datass.TOP$Rec_data$Tags2009_R1_R1
tags.2009.am = estimation$`tag_recapture[Tags2009_R1_R1]`$recaptured_2010

plot(size.class, tags.2009.om)
points(size.class, tags.2009.am, col = "red", pch = 3)


## TAGS SCANNED
tags.2009.om = datass.TOP$scannedN$Tags2009_R1_R1
tags.2009.am = estimation$`tag_recapture[Tags2009_R1_R1]`$scanned_2010

plot(size.class, tags.2009.om)
points(size.class, tags.2009.am, col = "red", pch = 3)


## AGE FREQUENCY
age.om = datass.TOP$catch_age$LL[,"2010",1,1,1]
age.am = as.numeric(estimation$`catch_at[LL_catchA]`$`2010`)

plot(age.om, ylim = c(0, 150))
points(age.am*500, col = "red", pch = 3)
lines(500*ogive("dbnormal", 1:35, params = list(top=10, sigma_left=2, sigma_right=10)))


```


Does \@catch_at LL_catchA add up to 1000 every year?

```{r, echo=F}
estimation = extract.csl.file("C:/Users/STA384/Documents/GitHub/planetfish2_bugs/Output/TOA_bug_1/casal_estimation.csl")
temp = as.numeric(estimation$`catch_at[LL_catchA]`$`2000`) # this is a proportion at age class.

sum(temp)

```
CONCLUSION: Undetermined. Only gives proportion, not quantity of fish. Can compare this frequency to selectivity possibly?
In any case, still need to find where catchA numbers are reported in CASAL files.




Do scanned fish in \@tag_recapture Tags2005_R1_R1 add up to 6000 tonnes?

```{r, echo=F}
class_mins = as.numeric(estimation$`tag_recapture[Tags2005_R1_R1]`$class_mins)
scanned    = as.numeric(estimation$`tag_recapture[Tags2005_R1_R1]`$scanned_2006)

plot(class_mins[-length(class_mins)], scanned)



```
CONCLUSION: I need to convert length to wight to answer this question. I think this process requires length to age to weight calculation, but length to age is the inverse of Von Bertalanffy which cannot take L>L_inf. This is a problem if any length classes exceed L_inf, which they do. 




Does frequency of scanned fish in \@tag_recapture Tags2005_R1_R1 match fishing selectivity? i.e. does tagging selectivity match fishing selectivity?


















## Warnings

Warning message:
In get_casal_data(Yr_current = om$years[y], datass = datass, om = om,  :
  Metiers in OM that are not included in Assessment: LL1
CONCLUSION: this warning shows up in Paul's stuff and mine.



In casal.string.to.vector.of.numbers(casal.remove.first.words(lines[i],  ... :
  NAs introduced by coercion
CONCLUSION: Ask Paul...
